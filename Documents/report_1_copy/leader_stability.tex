\chapter{Leader Stability}

\paragraph{}In this section, we consider under what circumstances a new leader will be elected. For some applications of a leader election primitive, changing the leader might be costly or inconvenient, so it would be desirable to avoid doing so unless it is necessary. In fact, with perfect clocks, without some kind of “stability” condition limiting when new leaders can be elected, we could solve the problem with a much simpler algorithm: whenever a node becomes a sink because of a channel going down, it elects itself; a node adopts any leader it hears about with a later timestamp.
\paragraph{}The algorithm of Derhab and Badache [5] achieves stability by using inferences on the overlap of time intervals, included in messages, to ensure that an older, possibly viable, leader is maintained rather than electing a new one. Their inferences re- quire a more complicated set of rules and messages than our algorithm, which elects a new leader whenever local conditions indicate that all paths to an older leader have been lost. While topology changes are taking place, our algorithm may elect new leaders while paths still exist, in a global view, to old leaders. However, we show that new leaders will not be elected by our algorithm if execution starts from a leader- oriented state in which the channels between one pair of nodes fail, while the old leader is still a part of the connected component.
\paragraph{}While the correctness proof of our algorithm uses a general notion of time, T , for the stability proof we need a stricter requirement on the temporal order of events. Because it is of critical importance to determine which leaders are older and which ones are newer, we need the clock times of non-causality-related events to be ordered consistently with the global times at which the events occur in order to achieve stability. If perfect clocks are used to implement T , then Theorem 2 provides the stability proof of the algorithm. Note that with perfect clocks nodes have an accurate notion of the current time, which is equivalent to having access to global time.
\paragraph{Theorem 2}Suppose at global time t ' a connected component CC' of Gchan is leader- oriented with leader l. Furthermore, suppose the two channels between a single pair of nodes in CC' go down, the latter of these two $ChannelDown$ events occurs at time t > t ' , and no other topology changes occur between t ' and t. Let the resulting con- nected component containing l be CC. Then, as long as there are no further topology changes in CC, no node in CC elects itself.
\paragraph{Proof}Only one of the two $ChannelDown$ events can create a sink in CC. This is the $ChannelDown$ event that occurs at the node with the greater height (say v). Suppose that this is the latter of the two $ChannelDown$ events, and it occurs at time t, (since, even if it is the first of the two $ChannelDown$ events, by the code, Update messages received by v on the incoming channel will be ignored after its outgoing channel goes down).
\subparagraph{}If the loss of the channel at time t does not create a sink in CC, then no Update messages are sent in CC and no node in CC elects itself.
\subparagraph{}Otherwise, suppose the loss of the channel causes some node u in CC to become a sink. Then u starts a new RL (t, u, 0).
\subparagraph{}Suppose in contradiction some node in CC elects itself after time t. Suppose the first time this happens is time te .
\paragraph{Claim 1}Every message in transit after t has either $\tau \geq _t or lts \leq -t_e$.
\paragraph{}Claim 1 follows from Property B and the assumption that no messages are in transit just before the $ChannelDown$ event at time t. \paragraph{Claim 2}After time t and before te no new RL prefix is started.
\subparagraph{Proof}Suppose in contradiction a new RL prefix is started after t and before te . Let tr be the first time this happens. Since there are no topology changes or elections in this interval, the new RL prefix must be started because some node, call it i, executes Line 13 of Figure 2 in response to the receipt of an Update message at tr .
\subparagraph{}There are two cases in which a node executes Line 13 of Figure 2:
\subparagraph{}Case 1: After updating the height of one its neighbors, in response to the mes- sage received, node i views all its neighbors as having RL (0, 0, 0). By Claim 1 and Property A, the Update message received must have $\tau$ $\geq$ t, and, since t > 0, this is a contradiction.
\subparagraph{}Case 2: After updating the height of one its neighbors in response to the message received, node i views all neighbors as having the same reflected RL (s, j, 1), but $j = i$. Since at tr (the time when node i receives the Update message that causes it to start a new RL), the newest RL prefix is (t, u), this common reflected RL has $s \leq t$. By Claim 1, s $\geq$ t, so $s = t$. Since only one node loses its last outgoing link at time t, no node besides u takes a step at time t and thus j = u.
\subparagraph{}Thus, in i’s view, all the neighbors of i have $RL (t, u, 1)$ but i = u. By Property F, all neighbors of i are in RD(t, u). By Property G with respect to a neighbor of i, i is also in RD(t, u).
\subparagraph{}Since i is a (temporary) sink during the execution of this step, i must still have RL (t, u). Since i 6= u, i must have a neighbor j that is its predecessor in RD(t, u). Property H, part (1), implies that i’s reflection bit must also be 1. But then Property H, part (3), implies that the height token for j in i’s view must be smaller than i’s height, contradicting i being a sink. (End of Proof of Claim 2.)
\subparagraph{}By Claim 2, the node that elects itself at time te must be u.
\subparagraph{}Note that during $(t,t_e)$, the only way a node in $CC$ can change its height is by becoming a sink, since there is only one leader pair present in $CC$. Thus in the following, we will use “becoming a sink” interchangeably with “changing height”.
\subparagraph{}From the hypothesis of the theorem, at time $t'$ the connected component $CC'$ is l-oriented. By definition of l-oriented, $\overrightarrow{\text {CC'}}$ is a DAG with the unique sink being $l$. Thus every node in $CC'$ has a (directed) path in $\overrightarrow{\text {CC'}}$ to $l$. Let $\overrightarrow{\text{CC}}$ be the result of removing the directed edge corresponding to ${u, v}$ from $\overrightarrow{\text {CC'}}$. Let $A$ be the set of nodes in $CC$ that have a (directed) path to $l$ in $\overrightarrow{\text{CC}}$ (i.e., after the $ChannelDown$ at time $t$), and let $B$ be the set of nodes in $CC$ that no longer have a (directed) path to $l$ in $\overrightarrow{\text {CC}}$. Clearly $l$ is in $A$ and $u$ is in $B$.

\paragraph{Claim 3}No node in A becomes a sink during (t,te ).
\subparagraph{Proof}By induction on the distance d from the node to l in CC.
\subparagraph{}Basis: d = 0. By definition, the leader l is never a sink.
\subparagraph{}Induction: d > 0. Consider a node $a \in A$ at distance d from l in CC. At time t, a has a neighbor a' whose distance to l in CC is d - 1 such that the edge in CC between a and a' (in the views of both a and a' ) is directed from a to a' . By the inductive hypothesis, a' is never a sink during [t,te ] and thus keeps the same height. Since the height of a cannot decrease (by Property B, since there is no new leader pair), the edge in CC between a and a' (in the views of both a and a' ) remains directed from a to a' . (End of Proof of Claim 3.)
\subparagraph{}Next, we are going to show, by induction on the distance from u in $RD (t, u)$, that at time te all nodes in $RD (t, u)$ (except for node u) have $RL (t, u, 1)$. The base case is true because by the precondition for node u to elect itself at time te , all its neighbors must have $RL (t, u, 1)$.
\subparagraph{}Therefore, all nodes at distance 1 from u in $RD (t, u)$ have $RL (t, u, 1)$. Suppose all nodes at distance k from u in $RD (t, u)$ have $RL (t, u, 1)$. We need to show that all nodes at distance k + 1 from u in $RD (t, u)$ have $RL (t, u, 1)$ too. Let x be an arbitrary node at distance k + 1 from u in $RD (t, u)$. By the definition of RD, x is a descendant of some node at distance k from u in $RD (t, u)$. By the inductive hypothesis and Property H, Part (1), it follows that x has $RL (t, u, 1)$. Therefore, we know that at time te there can be no height tokens in the system with RL (t, u, 0). Then by Property G, every node that has $RL (t, u, 1)$ must view all its neighbors as having $RL (t, u, 1)$. But since some node with $RL (t, u, 1)$ is a neighbor of some node in A, this contradicts Claim 3 and Property G.
\paragraph{}The stability condition above is no longer true if we use logical clocks to implement T , instead of perfect clocks. Because logical clocks ensure only a happens- before relation between events, it is not possible to distinguish old leaders from new ones if there is no causal chain between their elections. Figure 6 shows an example situation in which the use of logical clocks leads to a node electing itself despite the hypotheses of Theorem 2 holding. However, if we add an extra requirement to Theorem 2 that the RL prefixes at all nodes are (0, 0, 0) before the last topology change, then no pre-existing RL’s are present and we can guarantee that no node will elect itself, using a proof similar to the one of Theorem 2. This, however, is a weaker stability condition.